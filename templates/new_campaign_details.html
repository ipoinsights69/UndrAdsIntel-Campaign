{% extends "new_layout.html" %}

{% block title %}Campaign Details - UndrApp Intel{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
    <div>
        <div class="flex items-center gap-2 mb-2">
            <a href="/" class="text-primary-600 hover:text-primary-800 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
                Back to Dashboard
            </a>
        </div>
        <h1 class="text-3xl font-bold text-gray-800">Campaign #{{ campaign.id }}</h1>
        <div class="mt-2">
            {% if campaign.status == 'completed' %}
            <span class="badge-green">Completed</span>
            {% elif campaign.status == 'failed' %}
            <span class="badge-red">Failed</span>
            {% elif campaign.status == 'email_sending' %}
            <span class="badge-blue">Email Sending</span>
            {% elif campaign.status == 'followups_active' %}
            <span class="badge-purple">Followups Active</span>
            {% else %}
            <span class="badge">{{ campaign.status }}</span>
            {% endif %}
        </div>
    </div>
    <button id="refresh-data" class="btn-secondary">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
        </svg>
        Refresh Data
    </button>
</div>

<!-- Campaign Overview -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
    <!-- Campaign Status Card -->
    <div class="card">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Campaign Status</h2>
        
        <div class="grid grid-cols-2 gap-4 mb-6">
            <!-- Total Apps -->
            <div class="flex items-center">
                <div class="p-2 rounded-lg bg-gradient-to-br from-blue-400 to-blue-600 text-white mr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Total Apps</p>
                    <p class="text-lg font-semibold text-gray-800" id="total-apps">{{ campaign.total_apps }}</p>
                </div>
            </div>
            
            <!-- Apps with Contacts -->
            <div class="flex items-center">
                <div class="p-2 rounded-lg bg-gradient-to-br from-green-400 to-green-600 text-white mr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z" />
                    </svg>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Apps with Contacts</p>
                    <p class="text-lg font-semibold text-gray-800" id="apps-with-contacts">{{ campaign.apps_with_contacts }}</p>
                </div>
            </div>
            
            <!-- Emails Generated -->
            <div class="flex items-center">
                <div class="p-2 rounded-lg bg-gradient-to-br from-purple-400 to-purple-600 text-white mr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                        <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                    </svg>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Emails Generated</p>
                    <p class="text-lg font-semibold text-gray-800" id="emails-generated">{{ campaign.emails_generated }}</p>
                </div>
            </div>
            
            <!-- Emails Sent -->
            <div class="flex items-center">
                <div class="p-2 rounded-lg bg-gradient-to-br from-orange-400 to-orange-600 text-white mr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Emails Sent</p>
                    <p class="text-lg font-semibold text-gray-800" id="emails-sent">{{ campaign.emails_sent }}</p>
                </div>
            </div>
        </div>
        
        <!-- Progress Bars -->
        <div class="space-y-4">
            <!-- Contact Extraction Progress -->
            <div>
                <div class="flex justify-between mb-1">
                    <span class="text-sm font-medium text-gray-700">Contact Extraction</span>
                    <span class="text-sm font-medium text-gray-700" id="extraction-percentage">{{ campaign.extraction_percentage }}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div class="bg-primary-600 h-2.5 rounded-full" id="extraction-progress" style="width: {{ campaign.extraction_percentage }}%"></div>
                </div>
            </div>
            
            <!-- Email Generation Progress -->
            <div>
                <div class="flex justify-between mb-1">
                    <span class="text-sm font-medium text-gray-700">Email Generation</span>
                    <span class="text-sm font-medium text-gray-700" id="generation-percentage">{{ campaign.generation_percentage }}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div class="bg-primary-600 h-2.5 rounded-full" id="generation-progress" style="width: {{ campaign.generation_percentage }}%"></div>
                </div>
            </div>
            
            <!-- Email Sending Progress -->
            <div>
                <div class="flex justify-between mb-1">
                    <span class="text-sm font-medium text-gray-700">Email Sending</span>
                    <span class="text-sm font-medium text-gray-700" id="sending-percentage">{{ campaign.sending_percentage }}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div class="bg-primary-600 h-2.5 rounded-full" id="sending-progress" style="width: {{ campaign.sending_percentage }}%"></div>
                </div>
            </div>
        </div>
        
        <div class="mt-4 text-sm text-gray-500 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
            </svg>
            <span>Last updated: <span id="last-updated">{{ campaign.last_updated }}</span></span>
        </div>
    </div>
    
    <!-- Email Statistics Card -->
    <div class="card">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Email Statistics</h2>
        
        <div class="grid grid-cols-1 gap-4 mb-6">
            <!-- Emails Sent -->
            <div class="flex items-center">
                <div class="p-2 rounded-lg bg-gradient-to-br from-blue-400 to-blue-600 text-white mr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                        <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                    </svg>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Emails Sent</p>
                    <p class="text-lg font-semibold text-gray-800" id="total-emails-sent">{{ campaign.total_emails_sent }}</p>
                </div>
            </div>
            
            <!-- Replies Received -->
            <div class="flex items-center">
                <div class="p-2 rounded-lg bg-gradient-to-br from-green-400 to-green-600 text-white mr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 13V5a2 2 0 00-2-2H4a2 2 0 00-2 2v8a2 2 0 002 2h3l3 3 3-3h3a2 2 0 002-2zM5 7a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zm1 3a1 1 0 100 2h3a1 1 0 100-2H6z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Replies Received</p>
                    <p class="text-lg font-semibold text-gray-800" id="replies-received">{{ campaign.replies_received }}</p>
                </div>
            </div>
            
            <!-- Reply Rate -->
            <div class="flex items-center">
                <div class="p-2 rounded-lg bg-gradient-to-br from-purple-400 to-purple-600 text-white mr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5 3a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2H5zm9 4a1 1 0 10-2 0v6a1 1 0 102 0V7zm-3 2a1 1 0 10-2 0v4a1 1 0 102 0V9zm-3 3a1 1 0 10-2 0v1a1 1 0 102 0v-1z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Reply Rate</p>
                    <p class="text-lg font-semibold" id="reply-rate">
                        {% if campaign.reply_rate >= 15 %}
                        <span class="text-green-600">{{ campaign.reply_rate }}%</span>
                        {% elif campaign.reply_rate >= 5 %}
                        <span class="text-yellow-600">{{ campaign.reply_rate }}%</span>
                        {% else %}
                        <span class="text-red-600">{{ campaign.reply_rate }}%</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Reply Rate Chart Placeholder -->
        <div class="bg-gray-100 rounded-lg p-4 flex items-center justify-center h-40">
            <div class="text-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                <p class="text-gray-500 text-sm">Reply rate over time chart</p>
            </div>
        </div>
    </div>
    
    <!-- Email Sequence Card -->
    <div class="card">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Email Sequence</h2>
        
        <div class="grid grid-cols-1 gap-4 mb-6">
            <!-- Initial Emails -->
            <div class="flex items-center">
                <div class="p-2 rounded-lg bg-gradient-to-br from-blue-400 to-blue-600 text-white mr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                        <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                    </svg>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Initial Emails</p>
                    <p class="text-lg font-semibold text-gray-800" id="initial-emails">{{ campaign.initial_emails }}</p>
                </div>
            </div>
            
            <!-- Follow-up Emails -->
            <div class="flex items-center">
                <div class="p-2 rounded-lg bg-gradient-to-br from-purple-400 to-purple-600 text-white mr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z" />
                        <path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 002-2V9a2 2 0 00-2-2h-1z" />
                    </svg>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Follow-up Emails</p>
                    <p class="text-lg font-semibold text-gray-800" id="followup-emails">{{ campaign.followup_emails }}</p>
                </div>
            </div>
        </div>
        
        <!-- Email Sequence Timeline -->
        <div class="space-y-4">
            <div class="flex items-start">
                <div class="flex-shrink-0 h-5 w-5 rounded-full bg-blue-500 flex items-center justify-center mt-1">
                    <span class="text-xs text-white font-bold">1</span>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-gray-800">Initial Email</h3>
                    <p class="text-xs text-gray-500">Sent immediately after contact extraction</p>
                </div>
            </div>
            
            <div class="flex items-start">
                <div class="flex-shrink-0 h-5 w-5 rounded-full bg-purple-500 flex items-center justify-center mt-1">
                    <span class="text-xs text-white font-bold">2</span>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-gray-800">Follow-up #1</h3>
                    <p class="text-xs text-gray-500">Sent 3 days after initial email</p>
                </div>
            </div>
            
            <div class="flex items-start">
                <div class="flex-shrink-0 h-5 w-5 rounded-full bg-purple-500 flex items-center justify-center mt-1">
                    <span class="text-xs text-white font-bold">3</span>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-gray-800">Follow-up #2</h3>
                    <p class="text-xs text-gray-500">Sent 5 days after follow-up #1</p>
                </div>
            </div>
            
            <div class="flex items-start">
                <div class="flex-shrink-0 h-5 w-5 rounded-full bg-purple-500 flex items-center justify-center mt-1">
                    <span class="text-xs text-white font-bold">4</span>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-gray-800">Follow-up #3</h3>
                    <p class="text-xs text-gray-500">Sent 7 days after follow-up #2</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Email Status Card -->
<div class="card mb-8">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">Email Status</h2>
    
    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
        <!-- Pending Emails -->
        <div class="flex flex-col items-center p-4 bg-gray-50 rounded-lg">
            <div class="p-3 rounded-full bg-gray-200 text-gray-600 mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <p class="text-sm text-gray-500 mb-1">Pending</p>
            <p class="text-xl font-bold text-gray-800" id="pending-emails">{{ campaign.pending_emails }}</p>
        </div>
        
        <!-- Sent Emails -->
        <div class="flex flex-col items-center p-4 bg-blue-50 rounded-lg">
            <div class="p-3 rounded-full bg-blue-200 text-blue-600 mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
            </div>
            <p class="text-sm text-gray-500 mb-1">Sent</p>
            <p class="text-xl font-bold text-gray-800" id="sent-emails">{{ campaign.sent_emails }}</p>
        </div>
        
        <!-- Replied Emails -->
        <div class="flex flex-col items-center p-4 bg-green-50 rounded-lg">
            <div class="p-3 rounded-full bg-green-200 text-green-600 mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                </svg>
            </div>
            <p class="text-sm text-gray-500 mb-1">Replied</p>
            <p class="text-xl font-bold text-gray-800" id="replied-emails">{{ campaign.replied_emails }}</p>
        </div>
        
        <!-- Failed Emails -->
        <div class="flex flex-col items-center p-4 bg-red-50 rounded-lg">
            <div class="p-3 rounded-full bg-red-200 text-red-600 mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <p class="text-sm text-gray-500 mb-1">Failed</p>
            <p class="text-xl font-bold text-gray-800" id="failed-emails">{{ campaign.failed_emails }}</p>
        </div>
    </div>
</div>

<!-- Apps Table Card -->
<div class="card mb-8">
    <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4 md:mb-0">Apps</h2>
        <div class="flex flex-col sm:flex-row gap-3">
            <!-- Search Input -->
            <div class="relative">
                <input type="text" id="search-input" placeholder="Search apps..." class="input-field pl-10 py-2">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
            </div>
            
            <!-- Status Filter -->
            <div class="relative">
                <select id="status-filter" class="input-field pr-10 py-2">
                    <option value="all">All Statuses</option>
                    <option value="has_contacts">Has Contacts</option>
                    <option value="no_contacts">No Contacts</option>
                    <option value="email_generated">Email Generated</option>
                    <option value="email_sent">Email Sent</option>
                    <option value="email_replied">Email Replied</option>
                    <option value="email_failed">Email Failed</option>
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
            </div>
            
            <!-- Export Button -->
            <button id="export-csv" class="btn-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
                Export CSV
            </button>
        </div>
    </div>
    
    <!-- Apps Table -->
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">App Name</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact Status</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email Generation</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email Status</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="apps-table-body">
                <!-- Table rows will be populated by JavaScript -->
            </tbody>
        </table>
    </div>
    
    <!-- Pagination Controls -->
    <div class="flex flex-col sm:flex-row items-center justify-between mt-6">
        <div class="text-sm text-gray-700 mb-4 sm:mb-0">
            Showing <span id="showing-items">1-10</span> of <span id="total-items">{{ campaign.total_apps }}</span> apps
        </div>
        <div class="flex items-center space-x-2">
            <button id="prev-page" class="btn-secondary py-1 px-3 disabled:opacity-50 disabled:cursor-not-allowed">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                </svg>
            </button>
            <button id="next-page" class="btn-secondary py-1 px-3 disabled:opacity-50 disabled:cursor-not-allowed">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
    </div>
</div>

<!-- Email Preview Modal -->
<div id="email-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <!-- Modal Header -->
        <div class="bg-gradient-to-r from-primary-600 to-primary-800 text-white px-6 py-4 rounded-t-xl flex items-center justify-between">
            <h3 class="text-xl font-bold" id="modal-app-name">App Name</h3>
            <button id="close-modal" class="text-white hover:text-gray-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        
        <!-- Modal Content -->
        <div class="p-6">
            <!-- Email Subject -->
            <div class="mb-6">
                <h4 class="text-sm font-medium text-gray-500 mb-1">Subject</h4>
                <p class="text-lg font-medium text-gray-800" id="email-subject"></p>
            </div>
            
            <!-- Email Tracking Status -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <h4 class="text-sm font-medium text-gray-500 mb-3">Email Tracking Status</h4>
                <div class="flex flex-wrap gap-4" id="email-tracking-status">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Initial Email -->
            <div class="mb-6">
                <div class="flex items-center mb-3">
                    <div class="p-1.5 rounded-full bg-blue-100 text-blue-600 mr-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                            <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                        </svg>
                    </div>
                    <h4 class="text-md font-semibold text-gray-800">Initial Email</h4>
                </div>
                <div class="border border-gray-200 rounded-lg p-4 bg-white">
                    <div id="initial-email-content" class="prose max-w-none"></div>
                </div>
            </div>
            
            <!-- Follow-up Emails -->
            <div id="followup-emails-container">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Define variables
    let currentPage = 1;
    const itemsPerPage = 10;
    let filteredApps = [];
    let allApps = [];
    let searchTerm = '';
    let statusFilter = 'all';
    let refreshInterval;
    
    // Status colors for badges
    const statusColors = {
        'replied': 'badge-green',
        'sent': 'badge-blue',
        'failed': 'badge-red',
        'pending': 'badge-yellow',
        'generated': 'badge-purple',
        'none': 'badge'
    };
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Fetch initial campaign progress
        updateCampaignStatus();
        
        // Fetch apps data
        fetchApps();
        
        // Set up refresh interval (every 10 seconds)
        refreshInterval = setInterval(updateCampaignStatus, 10000);
        
        // Set up event listeners
        document.getElementById('refresh-data').addEventListener('click', function() {
            updateCampaignStatus();
            fetchApps();
            showAlert('Data refreshed successfully', 'success');
        });
        
        document.getElementById('search-input').addEventListener('input', function() {
            searchTerm = this.value.toLowerCase();
            applyFilters();
        });
        
        document.getElementById('status-filter').addEventListener('change', function() {
            statusFilter = this.value;
            applyFilters();
        });
        
        document.getElementById('prev-page').addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                renderAppsTable();
            }
        });
        
        document.getElementById('next-page').addEventListener('click', function() {
            const maxPage = Math.ceil(filteredApps.length / itemsPerPage);
            if (currentPage < maxPage) {
                currentPage++;
                renderAppsTable();
            }
        });
        
        document.getElementById('export-csv').addEventListener('click', exportToCSV);
        
        // Modal close events
        document.getElementById('close-modal').addEventListener('click', closeModalWithAnimation);
        
        document.getElementById('email-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModalWithAnimation();
            }
        });
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModalWithAnimation();
            }
        });
    });
    
    // Function to update campaign status
    function updateCampaignStatus() {
        // In a real application, this would fetch data from the server
        // For now, we'll simulate with the existing data
        
        // Update progress bars
        const extractionPercentage = {{ campaign.extraction_percentage }};
        const generationPercentage = {{ campaign.generation_percentage }};
        const sendingPercentage = {{ campaign.sending_percentage }};
        
        document.getElementById('extraction-percentage').textContent = extractionPercentage + '%';
        document.getElementById('generation-percentage').textContent = generationPercentage + '%';
        document.getElementById('sending-percentage').textContent = sendingPercentage + '%';
        
        document.getElementById('extraction-progress').style.width = extractionPercentage + '%';
        document.getElementById('generation-progress').style.width = generationPercentage + '%';
        document.getElementById('sending-progress').style.width = sendingPercentage + '%';
        
        // Update last updated timestamp
        document.getElementById('last-updated').textContent = new Date().toLocaleString();
    }
    
    // Function to fetch apps data
    function fetchApps() {
        // In a real application, this would fetch data from the server
        // For now, we'll use sample data
        allApps = [
            {% for app in apps %}
            {
                id: {{ app.id }},
                name: "{{ app.name }}",
                contact_status: "{{ app.contact_status }}",
                contacts_count: {{ app.contacts_count }},
                email_generated: {{ app.email_generated|lower }},
                email_status: "{{ app.email_status }}",
                email_subject: "{{ app.email_subject }}",
                initial_email: "{{ app.initial_email|safe }}",
                followup_emails: [
                    {% for followup in app.followup_emails %}
                    "{{ followup|safe }}",
                    {% endfor %}
                ],
                email_tracking: {
                    status: "{{ app.email_tracking.status }}",
                    initial: "{{ app.email_tracking.initial }}",
                    followup1: "{{ app.email_tracking.followup1 }}",
                    followup2: "{{ app.email_tracking.followup2 }}",
                    followup3: "{{ app.email_tracking.followup3 }}"
                }
            },
            {% endfor %}
        ];
        
        // Apply initial filters
        applyFilters();
    }
    
    // Function to apply filters
    function applyFilters() {
        filteredApps = allApps.filter(app => {
            // Apply search filter
            const matchesSearch = app.name.toLowerCase().includes(searchTerm);
            
            // Apply status filter
            let matchesStatus = true;
            if (statusFilter === 'has_contacts') {
                matchesStatus = app.contact_status === 'has_contacts';
            } else if (statusFilter === 'no_contacts') {
                matchesStatus = app.contact_status === 'no_contacts';
            } else if (statusFilter === 'email_generated') {
                matchesStatus = app.email_generated;
            } else if (statusFilter === 'email_sent') {
                matchesStatus = app.email_status === 'sent';
            } else if (statusFilter === 'email_replied') {
                matchesStatus = app.email_status === 'replied';
            } else if (statusFilter === 'email_failed') {
                matchesStatus = app.email_status === 'failed';
            }
            
            return matchesSearch && matchesStatus;
        });
        
        // Reset to first page when filters change
        currentPage = 1;
        
        // Update pagination info
        updatePagination();
        
        // Render the table
        renderAppsTable();
    }
    
    // Function to update pagination controls
    function updatePagination() {
        const totalItems = filteredApps.length;
        const maxPage = Math.ceil(totalItems / itemsPerPage);
        const start = (currentPage - 1) * itemsPerPage + 1;
        const end = Math.min(start + itemsPerPage - 1, totalItems);
        
        document.getElementById('showing-items').textContent = totalItems > 0 ? `${start}-${end}` : '0-0';
        document.getElementById('total-items').textContent = totalItems;
        
        // Update button states
        document.getElementById('prev-page').disabled = currentPage <= 1;
        document.getElementById('next-page').disabled = currentPage >= maxPage;
    }
    
    // Function to render the apps table
    function renderAppsTable() {
        const tableBody = document.getElementById('apps-table-body');
        tableBody.innerHTML = '';
        
        if (filteredApps.length === 0) {
            // No apps found message
            const noAppsRow = document.createElement('tr');
            noAppsRow.innerHTML = `
                <td colspan="6" class="px-6 py-10 text-center">
                    <div class="flex flex-col items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p class="text-gray-600 mb-4">No apps found</p>
                        <button id="reset-filters" class="btn-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                            </svg>
                            Reset filters
                        </button>
                    </div>
                </td>
            `;
            tableBody.appendChild(noAppsRow);
            
            // Add event listener to reset filters button
            setTimeout(() => {
                const resetButton = document.getElementById('reset-filters');
                if (resetButton) {
                    resetButton.addEventListener('click', function() {
                        document.getElementById('search-input').value = '';
                        document.getElementById('status-filter').value = 'all';
                        searchTerm = '';
                        statusFilter = 'all';
                        applyFilters();
                    });
                }
            }, 0);
            
            return;
        }
        
        // Calculate slice for current page
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const currentPageApps = filteredApps.slice(startIndex, endIndex);
        
        // Create table rows
        currentPageApps.forEach((app, index) => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 transition-colors duration-150';
            
            // Calculate the actual index in the filtered list
            const displayIndex = startIndex + index + 1;
            
            // Contact status badge
            let contactStatusBadge;
            if (app.contact_status === 'has_contacts') {
                contactStatusBadge = `<span class="badge-green">${app.contacts_count} Contacts</span>`;
            } else {
                contactStatusBadge = `<span class="badge">None</span>`;
            }
            
            // Email generation badge
            let emailGenerationBadge;
            if (app.email_generated) {
                emailGenerationBadge = `<span class="badge-purple">Generated</span>`;
            } else if (app.contact_status === 'has_contacts') {
                emailGenerationBadge = `<span class="badge-yellow">Pending</span>`;
            } else {
                emailGenerationBadge = `<span class="badge">N/A</span>`;
            }
            
            // Email status badge
            let emailStatusBadge;
            if (app.email_status === 'replied') {
                emailStatusBadge = `<span class="badge-green">Replied</span>`;
            } else if (app.email_status === 'sent') {
                emailStatusBadge = `<span class="badge-blue">Sent</span>`;
            } else if (app.email_status === 'failed') {
                emailStatusBadge = `<span class="badge-red">Failed</span>`;
            } else if (app.email_generated) {
                emailStatusBadge = `<span class="badge-yellow">Pending</span>`;
            } else {
                emailStatusBadge = `<span class="badge">N/A</span>`;
            }
            
            // View email button
            let viewEmailButton = '';
            if (app.email_generated) {
                viewEmailButton = `
                    <button class="text-primary-600 hover:text-primary-800 view-email" data-app-id="${app.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
            }
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${displayIndex}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${app.name}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">${contactStatusBadge}</td>
                <td class="px-6 py-4 whitespace-nowrap">${emailGenerationBadge}</td>
                <td class="px-6 py-4 whitespace-nowrap">${emailStatusBadge}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${viewEmailButton}</td>
            `;
            
            tableBody.appendChild(row);
        }
    }
    
    // Function to close modal with animation
    function closeModalWithAnimation() {
        const modal = document.getElementById('email-modal');
        const modalContent = modal.querySelector('.bg-white');
        
        modalContent.classList.remove('scale-100', 'opacity-100');
        modalContent.classList.add('scale-95', 'opacity-0');
        
        setTimeout(() => {
            modal.classList.add('hidden');
            modalContent.classList.remove('scale-95', 'opacity-0');
        }, 300);
    }
    
    // Close modal when clicking outside or on close button
    document.getElementById('email-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModalWithAnimation();
        }
    });
    
    document.getElementById('close-modal').addEventListener('click', closeModalWithAnimation);
    
    // Close modal when pressing Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !document.getElementById('email-modal').classList.contains('hidden')) {
            closeModalWithAnimation();
        }
    });
    
    // Pagination event listeners
    document.getElementById('prev-page').addEventListener('click', function() {
        if (currentPage > 1) {
            currentPage--;
            renderAppsTable();
        }
    });
    
    document.getElementById('next-page').addEventListener('click', function() {
        if (currentPage < Math.ceil(filteredApps.length / itemsPerPage)) {
            currentPage++;
            renderAppsTable();
        }
    });
    
    // Function to export to CSV
    function exportToCSV() {
        if (filteredApps.length === 0) {
            showAlert('No data to export', 'error');
            return;
        }
        
        // Create CSV content
        let csvContent = 'Index,App Name,Contact Status,Contacts Count,Email Generated,Email Status\n';
        
        filteredApps.forEach((app, index) => {
            const csvRow = [
                index + 1,
                app.name,
                app.contact_status,
                app.contacts_count || 0,
                app.email_generated ? 'Yes' : 'No',
                app.email_status
            ];
            
            // Escape commas in fields
            const escapedRow = csvRow.map(field => {
                const fieldStr = String(field);
                return fieldStr.includes(',') ? `"${fieldStr}"` : fieldStr;
            });
            
            csvContent += escapedRow.join(',') + '\n';
        });
        
        // Create and download CSV file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', `campaign_${{{ campaign.id }}}_apps.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showAlert('CSV exported successfully', 'success');
    }
</script>
{% endblock %}